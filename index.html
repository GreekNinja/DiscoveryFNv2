<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortnite Discovery Browser</title>
    <meta name="description" content="Fortnite Discovery Browser - Fast, Secure, Reliable">
    <meta name="robots" content="noindex, nofollow"> <!-- Anti-Crawler -->
    
    <!-- Tailwind CSS (Corrected) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome (CDN via Cloudflare) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for Metrics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Rajdhani', 'sans-serif'],
                    },
                    colors: {
                        fn: {
                            dark: '#0B0E14',
                            card: '#151A23',
                            accent: '#FACC15', // Yellow
                            highlight: '#3B82F6' // Blue
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0B0E14; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            border-color: rgba(250, 204, 21, 0.5);
        }
        
        .glass-nav {
            background: rgba(11, 14, 20, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Progress Bar Animation */
        #timer-bar {
            transition: width 1s linear;
        }
        
        .category-active {
            border-color: #FACC15 !important;
            background-color: #1e293b !important;
        }

        /* Security Overlay Styles */
        #security-overlay {
            position: fixed;
            inset: 0;
            background-color: #0B0E14;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }
        
        /* Prevent text selection for basic protection */
        body.protected {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="bg-fn-dark text-white min-h-screen font-sans selection:bg-yellow-500/30 protected" oncontextmenu="return false;">

    <!-- Security Gateway Overlay -->
    <div id="security-overlay">
        <div class="text-center max-w-md px-6">
            <div class="mb-6 relative">
                <div class="w-16 h-16 border-4 border-slate-700 border-t-yellow-400 rounded-full animate-spin mx-auto"></div>
                <i class="fa-solid fa-shield-halved absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-slate-500"></i>
            </div>
            <h2 class="text-2xl font-display font-bold text-white mb-2">Checking Connection</h2>
            <p class="text-slate-400 text-sm mb-6" id="security-status">Verifying browser integrity...</p>
            
            <div class="flex flex-col gap-2 text-xs text-slate-500">
                <div class="flex items-center justify-between bg-slate-800/50 p-2 rounded border border-slate-700/50" id="row-ddos">
                    <span>DDoS Protection</span>
                    <span class="text-green-400" id="icon-ddos"><i class="fa-solid fa-check"></i></span>
                </div>
                <div class="flex items-center justify-between bg-slate-800/50 p-2 rounded border border-slate-700/50" id="row-adblock">
                    <span>Adblock Check</span>
                    <span id="icon-adblock" class="text-yellow-400"><i class="fa-solid fa-circle-notch fa-spin"></i></span>
                </div>
                <div class="flex items-center justify-between bg-slate-800/50 p-2 rounded border border-slate-700/50" id="row-bot">
                    <span>Bot Detection</span>
                    <span id="icon-bot" class="text-yellow-400"><i class="fa-solid fa-circle-notch fa-spin"></i></span>
                </div>
            </div>
            
            <div id="security-error" class="hidden mt-6 bg-red-500/10 border border-red-500/50 text-red-400 p-3 rounded text-sm font-bold">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i> <span id="error-msg">Access Denied</span>
            </div>
            
            <div id="skip-btn" class="hidden mt-4">
                <button onclick="bypassSecurity()" class="text-xs text-slate-500 hover:text-slate-300 underline">Skip Checks (Dev)</button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-nav border-b border-slate-800/50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <!-- Logo -->
                <div class="flex items-center gap-3 cursor-pointer group" onclick="resetToHome(true)">
                    <div class="bg-gradient-to-br from-yellow-400 to-orange-500 text-black p-2 rounded-lg shadow-lg shadow-yellow-500/20 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-gamepad text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-display font-bold tracking-wider uppercase text-white leading-none">
                        FN<span class="text-yellow-400">Zone</span><br>
                        <span class="text-xs text-slate-400 tracking-[0.2em] font-sans font-normal">DISCOVERY</span>
                    </h1>
                </div>

                <!-- Controls & Timer -->
                <div class="flex items-center gap-4 w-full sm:w-auto justify-end">
                    <!-- Info Display -->
                    <div class="hidden md:flex flex-col items-end mr-4 text-xs text-slate-500">
                        <div class="flex items-center gap-1">
                            <i class="fa-regular fa-clock"></i>
                            <span>Updated:</span>
                            <span id="last-updated-time" class="text-slate-300 font-mono">--:--</span>
                        </div>
                    </div>

                    <!-- Timer Display -->
                    <div class="flex flex-col items-end mr-2">
                        <div class="flex items-center gap-2 text-xs font-mono text-slate-400">
                            <span>REFRESH:</span>
                            <span id="timer-text" class="text-yellow-400 font-bold">05:00</span>
                        </div>
                        <!-- Progress Bar Container -->
                        <div class="w-32 h-1.5 bg-slate-800 rounded-full mt-1 overflow-hidden">
                            <div id="timer-bar" class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 w-full rounded-full"></div>
                        </div>
                    </div>

                    <!-- Status Badge -->
                    <div class="text-xs font-bold px-2 py-2 rounded-full border border-slate-700/50 bg-slate-800/50 backdrop-blur-sm flex items-center justify-center shadow-sm w-8 h-8" id="status-indicator" title="Status">
                        <span class="relative flex h-2.5 w-2.5">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-slate-500"></span>
                        </span>
                    </div>
                    
                    <!-- Manual Refresh Button -->
                    <button onclick="forceRefresh()" class="p-2 text-slate-400 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors" title="Force Refresh Now">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-container" class="max-w-7xl mx-auto px-4 py-8 space-y-16 min-h-[80vh]">
         <div class="flex flex-col items-center justify-center h-64 text-slate-500 animate-pulse">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-slate-600"></i>
            <p>Loading...</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-black/20 backdrop-blur-lg text-slate-500 py-8 text-center border-t border-slate-800 mt-12 select-none">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-xs text-slate-600 text-left">
                 <p class="font-medium text-slate-700">Not affiliated with Epic Games.</p>
            </div>
            
            <!-- Cloudflare / Security Badge Simulation -->
            <div class="flex items-center gap-4">
                 <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-800/50 rounded-full border border-slate-700/50 hover:bg-slate-700 cursor-help" title="DDoS Protection Active">
                    <i class="fa-solid fa-shield-halved text-orange-400 text-xs"></i>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Secure</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-800/50 rounded-full border border-slate-700/50">
                    <i class="fa-solid fa-bolt text-yellow-400 text-xs"></i>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">CDN</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 border border-slate-700 text-white px-5 py-3 rounded-xl shadow-2xl transform translate-y-32 transition-all duration-500 z-50 flex items-center gap-3 backdrop-blur-md">
        <div class="bg-green-500/20 text-green-400 p-2 rounded-lg">
            <i class="fa-solid fa-check"></i>
        </div>
        <div>
            <p class="font-bold text-sm">Code Copied!</p>
            <p class="text-xs text-slate-400">Ready to paste in Fortnite.</p>
        </div>
    </div>

    <!-- Bait for Adblocker Detection -->
    <div id="ad-banner" class="ad-banner adsbox" style="position:absolute; top:-999px; left:-999px; width:1px; height:1px; background:transparent;"></div>

    <script>
        // --- Anti-DevTools & Protection ---
        
        // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        document.addEventListener('keydown', function(e) {
            if (
                e.keyCode === 123 || // F12
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) || // Ctrl+Shift+I/J/C
                (e.ctrlKey && e.keyCode === 85) // Ctrl+U
            ) {
                e.preventDefault();
            }
        });

        // --- Security Checks ---
        let securityCheckPassed = false;

        function bypassSecurity() {
            const overlay = document.getElementById('security-overlay');
            if(overlay) overlay.style.display = 'none';
            securityCheckPassed = true;
            checkAndSchedule();
        }
        
        async function runSecurityChecks() {
            if (securityCheckPassed) return;

            const statusEl = document.getElementById('security-status');
            const adblockEl = document.getElementById('icon-adblock');
            const botEl = document.getElementById('icon-bot');
            const overlay = document.getElementById('security-overlay');
            const errorBox = document.getElementById('security-error');
            const errorMsg = document.getElementById('error-msg');
            
            // Safety timeout to prevent infinite loading
            const safetyTimeout = setTimeout(() => {
                if (!securityCheckPassed) {
                    console.warn("Security check timed out, proceeding safely...");
                    bypassSecurity();
                }
            }, 5000); // 5 seconds max

            // Update Helper
            const updateStep = (rowId, iconId) => {
                const row = document.getElementById(rowId);
                const icon = document.getElementById(iconId);
                if(row) {
                    row.classList.replace('border-slate-700/50', 'border-green-500/30');
                    row.classList.replace('bg-slate-800/50', 'bg-green-500/10');
                }
                if(icon) icon.innerHTML = '<i class="fa-solid fa-check text-green-400"></i>';
            };

            try {
                // 1. DDoS (Simulated Instant)
                updateStep('row-ddos', 'icon-ddos');

                // 2. Adblock Detection (Fixed Logic)
                await new Promise(r => setTimeout(r, 300));
                const adBait = document.getElementById('ad-banner');
                const adStyles = adBait ? window.getComputedStyle(adBait) : null;
                
                if (!adBait || (adStyles && (adStyles.display === 'none' || adStyles.visibility === 'hidden'))) {
                     // Detected - Warn but don't block for now
                     if(adblockEl) adblockEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-yellow-400"></i>';
                } else {
                    updateStep('row-adblock', 'icon-adblock');
                }

                // 3. Bot Detection (Headless Check - Fast)
                await new Promise(r => setTimeout(r, 300));
                const isHeadless = navigator.webdriver || !navigator.languages || navigator.languages.length === 0;
                if (isHeadless) {
                    if(botEl) botEl.innerHTML = '<i class="fa-solid fa-xmark text-red-500"></i>';
                } else {
                    updateStep('row-bot', 'icon-bot');
                }
                
                // 3. Finish (Fast fade out)
                statusEl.textContent = "Connection Secure";
                statusEl.classList.add('text-green-400');
                await new Promise(r => setTimeout(r, 400));
                
                clearTimeout(safetyTimeout);
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    securityCheckPassed = true;
                    checkAndSchedule(); 
                }, 300);

            } catch (e) {
                console.error("Security Check Error:", e);
                bypassSecurity();
            }
        }

        // --- Configuration ---
        const NEXT_DATA_API = "https://fnzone.es/_next/data/uia3PTQJwe47bgy4hnG2c/en";
        const BACKEND_API = "https://fnzone.es/api/backend/v2";
        const METRICS_API_BASE = "https://api.fortnite.com/ecosystem/v1/islands";
        const HOME_ENDPOINT = "/discover.json";
        
        function getProxies(targetUrl) {
            const encoded = encodeURIComponent(targetUrl);
            return [
                `https://corsproxy.io/?${encoded}`,
                `https://api.allorigins.win/raw?url=${encoded}`,
                `https://thingproxy.freeboard.io/fetch/${targetUrl}`,
                targetUrl
            ];
        }
        
        const REFRESH_INTERVAL_MS = 5 * 60 * 1000; 
        
        const STORAGE_KEY_DATA = 'fn_discovery_data_v6';
        const STORAGE_KEY_TIMESTAMP = 'fn_discovery_timestamp_v6';

        // --- State ---
        let timerInterval;
        let currentView = 'home'; 
        let currentCategoryName = '';
        let currentIslandCode = '';
        let currentCreatorId = '';
        let chartInstance = null;
        
        window.cachedSurfaces = [];

        // --- Sample Data ---
        const SAMPLE_DATA = {
            "pageProps": {
                "discoveryData": [
                    {
                        "panelName": "Battle_Royales_ByEpic_new",
                        "panelDisplayName": { "en": "Battle Royales by Epic" },
                        "panelSubtitle": { "en": "BR: 20 min | Reload: 15 min | Blitz: 5 min" },
                        "firstPage": [
                            { "islandCode": "set_br_playlists", "islandTitle": "Battle Royale", "creatorSlug": "Epic", "smallImage": "https://cdn2.unrealengine.com/cdn-uploader-FNBR_38-00_C6MS2_BR_DiscoverPlaylistTile_-480x270-1f80c40f.jpg", "globalCCU": 131632 },
                            { "islandCode": "set_habanero_blastberry_playlists", "islandTitle": "Reload Ranked", "creatorSlug": "Epic", "smallImage": "https://cdn2.unrealengine.com/en-fnbr-37-30-reload-rankedreload-build-discoverplaylisttile-480x270-480x270-d2341c19bde6.jpg", "globalCCU": 46769 }
                        ]
                    }
                ],
                "searchSurfaces": [
                     { "displayName": "1v1", "surfaceHref": "1v1", "iconImage": "https://cdn2.unrealengine.com/icon-1v1-32x32-fe198a29557a.png" }
                ]
            }
        };

        // --- Helper Functions ---

        function formatCCU(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(num || 0);
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function sanitizeTag(tag) {
            const lower = tag.toLowerCase().trim();
            const map = {
                'free for all': 'ffa',
                'prop hunt': 'prophunt',
                'zone wars': 'zonewars',
                'box fight': 'boxfight',
                'death run': 'deathrun',
                'edit course': 'editcourse',
                'hide and seek': 'hideandseek',
                'open world': 'openworld',
                'team deathmatch': 'teamdeathmatch',
                'battle royale': 'battleroyale',
                'gun game': 'gungame'
            };
            return map[lower] || lower.replace(/\s+/g, '');
        }

        function copyCode(code, event) {
            if(event) event.stopPropagation(); 
            const textArea = document.createElement("textarea");
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const toast = document.getElementById('toast');
                toast.classList.remove('translate-y-32');
                setTimeout(() => toast.classList.add('translate-y-32'), 2500);
            } catch (err) {
                console.error('Fallback copy failed', err);
            }
            document.body.removeChild(textArea);
        }

        function updateLastUpdatedTime(timestamp) {
            const date = new Date(parseInt(timestamp));
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const el = document.getElementById('last-updated-time');
            if (el) el.textContent = timeStr;
        }

        // --- Definitions Restored ---

        function updateTimerDisplay(msRemaining) {
            if (currentView !== 'home') {
                 const timerText = document.getElementById('timer-text');
                 const timerBar = document.getElementById('timer-bar');
                 if(timerText) timerText.textContent = "--:--";
                 if(timerBar) timerBar.style.width = "0%";
                 return;
            }

            const secondsRemaining = Math.max(0, Math.floor(msRemaining / 1000));
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            
            const textEl = document.getElementById('timer-text');
            const barEl = document.getElementById('timer-bar');
            
            if(textEl) textEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if(barEl) {
                const percentage = (msRemaining / REFRESH_INTERVAL_MS) * 100;
                barEl.style.width = `${percentage}%`;
                
                if (msRemaining < 10000) {
                    textEl.classList.add('text-red-500', 'animate-pulse');
                    textEl.classList.remove('text-yellow-400');
                    barEl.classList.replace('from-yellow-400', 'from-red-500');
                } else {
                    textEl.classList.remove('text-red-500', 'animate-pulse');
                    textEl.classList.add('text-yellow-400');
                    barEl.classList.replace('from-red-500', 'from-yellow-400');
                }
            }
        }

        function updateURL(path, params = {}) {
            const searchParams = new URLSearchParams();
            for (const [key, value] of Object.entries(params)) {
                if (value) searchParams.set(key, value);
            }
            window.location.hash = path + (searchParams.toString() ? '?' + searchParams.toString() : '');
        }

        function resetToHome(pushState = true) {
            if (pushState) {
                 updateURL('/discovery');
            }
            currentView = 'home';
            const savedDataStr = localStorage.getItem(STORAGE_KEY_DATA);
            if (savedDataStr) {
                renderApp(JSON.parse(savedDataStr));
            } else {
                fetchHomeData(false); 
            }
        }

        function goBack() {
             if (currentView === 'creator') {
                if (currentIslandCode) updateURL('/island', { code: currentIslandCode });
                else resetToHome(true);
            }
            else if (currentView === 'details') {
                if (currentCategoryName) {
                    updateURL('/creative', { tag: currentCategoryName }); 
                } else {
                    resetToHome(true);
                }
            } else {
                resetToHome(true);
            }
        }

        function forceRefresh() {
             if (currentView === 'home') {
                localStorage.removeItem(STORAGE_KEY_TIMESTAMP);
                fetchHomeData(false);
            } else if (currentView === 'category' && currentCategoryName) {
                fetchCategoryData(currentCategoryName, false);
            } else if (currentView === 'details' && currentIslandCode) {
                viewIsland(currentIslandCode, false);
            } else if (currentView === 'creator' && currentCreatorId) {
                viewCreator(currentCreatorId, false);
            }
        }

        // --- Routing & API ---

        function handleRouting() {
            let hash = window.location.hash.substring(1);
            if (!hash) hash = '/discovery';
            if (!hash.startsWith('/')) hash = '/discovery';

            const [path, search] = hash.split('?');
            const params = new URLSearchParams(search);

            if (path === '/discovery') {
                if (currentView !== 'home') {
                     fetchHomeData(false); 
                }
            } 
            else if (path === '/island') {
                const code = params.get('code');
                if (code) viewIsland(code, false); 
            } 
            else if (path === '/creator') {
                const id = params.get('name'); 
                if (id) viewCreator(id, false);
            } 
            else if (path === '/creative') {
                const tag = params.get('tag');
                if (tag) fetchCategoryData(tag, false);
            } 
            else {
                 if (currentView !== 'home') resetToHome(false);
            }
        }

        window.addEventListener('hashchange', handleRouting);

        async function tryFetch(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (e) {
                console.warn(`Fetch failed for ${url}`, e);
                return null;
            }
        }

        async function performFetch(targetUrl) {
            setStatus('loading');
            const proxies = getProxies(targetUrl);
            
            let data = null;
            
            for (const url of proxies) {
                data = await tryFetch(url);
                if (data) break;
            }

            if (data) {
                if (data.contents) {
                    try { data = JSON.parse(data.contents); } catch (e) {}
                }
                return data;
            } else {
                setStatus('error');
                return null;
            }
        }

        async function loadIslandMetrics(code) {
            const fromDate = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const metricsUrl = `${METRICS_API_BASE}/${code}/metrics/minute/peak-ccu?from=${fromDate}`;
            
            const data = await performFetch(metricsUrl);
            
            const canvas = document.getElementById('ccuChart');
            const liveDisplay = document.getElementById('live-ccu-display');
            
            if (data && data.intervals && data.intervals.length > 0) {
                const validPoints = data.intervals.filter(p => p.value !== null);
                
                if (liveDisplay && validPoints.length > 0) {
                     const lastValue = validPoints[validPoints.length - 1].value;
                     liveDisplay.innerHTML = `
                        <span class="relative flex h-2.5 w-2.5 mr-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                        </span>
                        ${formatNumber(lastValue)}
                     `;
                }

                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const labels = validPoints.map(p => {
                        const date = new Date(p.timestamp);
                        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    const values = validPoints.map(p => p.value);

                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(250, 204, 21, 0.5)'); 
                    gradient.addColorStop(1, 'rgba(250, 204, 21, 0.0)');

                    if (chartInstance) {
                        chartInstance.destroy();
                    }

                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Players (CCU)',
                                data: values,
                                borderColor: '#FACC15',
                                backgroundColor: gradient,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { intersect: false, mode: 'index' },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#1e293b',
                                    titleColor: '#fff',
                                    bodyColor: '#cbd5e1',
                                    borderColor: '#334155',
                                    borderWidth: 1,
                                    displayColors: false,
                                    callbacks: { label: (c) => 'Players: ' + c.parsed.y }
                                }
                            },
                            scales: {
                                x: { display: false },
                                y: {
                                    border: { display: false },
                                    grid: { color: '#334155', drawBorder: false },
                                    ticks: { color: '#94a3b8', maxTicksLimit: 5 }
                                }
                            }
                        }
                    });
                    document.getElementById('chart-container').classList.remove('hidden');
                }
            }
        }

        function createCard(island) {
            const title = island.islandTitle || island.title || 'Unknown Title';
            const code = island.islandCode || 'N/A';
            const rawImage = island.smallImage || island.image || island.backgroundImage || 'https://via.placeholder.com/480x270/151A23/ffffff?text=No+Image';
            const cleanImage = rawImage.split('?')[0];
            const ccu = formatCCU(island.globalCCU);
            const creator = island.creatorSlug || '';

            return `
                <div class="bg-fn-card rounded-2xl overflow-hidden card-hover group relative border border-slate-800 flex flex-col h-full cursor-pointer" onclick="viewIsland('${code}', true)">
                    <div class="relative aspect-video overflow-hidden bg-slate-900">
                        <img src="${cleanImage}" alt="${title}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" loading="lazy" onerror="this.src='https://via.placeholder.com/480x270/151A23/ffffff?text=Fortnite+Island'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60"></div>
                        <div class="absolute top-2 left-2 bg-black/60 backdrop-blur-md text-white text-[10px] font-bold px-2 py-1 rounded-md flex items-center gap-1.5 border border-white/10 shadow-lg">
                            <span class="relative flex h-1.5 w-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span></span>
                            ${ccu}
                        </div>
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center backdrop-blur-[2px]">
                            <button onclick="copyCode('${code}', event)" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold py-2.5 px-6 rounded-full transform translate-y-4 group-hover:translate-y-0 transition-all duration-300 shadow-[0_0_15px_rgba(250,204,21,0.5)] flex items-center gap-2">
                                <i class="fa-regular fa-copy"></i> Copy Code
                            </button>
                        </div>
                    </div>
                    <div class="p-4 flex-1 flex flex-col justify-between relative z-10">
                        <div>
                            <h3 class="font-display font-bold text-lg leading-tight mb-1.5 text-white group-hover:text-yellow-400 transition-colors line-clamp-1" title="${title}">${title}</h3>
                            ${creator ? `<div class="flex items-center gap-1 text-slate-400 text-xs mb-3"><i class="fa-solid fa-user-astronaut text-slate-600"></i><span class="text-slate-400 font-medium hover:text-slate-200 transition-colors">${creator}</span></div>` : '<div class="mb-3"></div>'}
                        </div>
                        <div class="mt-auto pt-3 border-t border-slate-800/50 flex justify-between items-center">
                            <span class="text-[10px] uppercase tracking-wider text-slate-500 font-bold">Code</span>
                            <span class="text-xs font-mono font-bold text-slate-300 bg-slate-900/80 border border-slate-700/50 px-2 py-1 rounded select-all cursor-pointer hover:bg-slate-800 hover:text-yellow-400 transition-colors" onclick="copyCode('${code}', event)">${code}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCategories(surfaces) {
            if (!window.cachedSurfaces) window.cachedSurfaces = surfaces;
            if (!surfaces || surfaces.length === 0) return '';

            const items = surfaces.map(surface => {
                const surfaceTag = sanitizeTag(surface.surfaceHref || surface.displayName);
                const isActive = currentView === 'category' && currentCategoryName === surfaceTag;
                const activeClass = isActive ? 'category-active' : '';
                const activeText = isActive ? 'text-yellow-400' : 'text-slate-400';
                const activeGrayscale = isActive ? 'grayscale-0 scale-110' : 'grayscale';

                return `
                <a href="javascript:void(0)" onclick="fetchCategoryData('${surfaceTag}', true)" class="flex flex-col items-center gap-3 p-4 bg-fn-card rounded-2xl hover:bg-slate-800 hover:border-yellow-400/50 border border-slate-800 transition-all duration-300 group min-w-[110px] shadow-lg hover:shadow-yellow-500/10 ${activeClass}">
                    <div class="w-10 h-10 relative p-1">
                        <img src="${surface.iconImage}" alt="${surface.displayName}" class="w-full h-full object-contain drop-shadow-md group-hover:scale-110 transition-transform duration-300 filter ${activeGrayscale} group-hover:grayscale-0">
                    </div>
                    <span class="text-[10px] font-bold ${activeText} group-hover:text-white uppercase tracking-wider text-center group-hover:text-yellow-400 transition-colors">${surface.displayName}</span>
                </a>
            `}).join('');

            if(currentView === 'details' || currentView === 'creator') return '';

            return `
                <section class="animate-fade-in mb-12">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-1 bg-gradient-to-b from-yellow-400 to-orange-500 rounded-full"></div>
                            <h2 class="text-2xl font-display font-bold text-white uppercase tracking-wide">Categories</h2>
                        </div>
                        ${currentView === 'category' ? 
                        `<button onclick="resetToHome(true)" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded-lg border border-slate-700 text-slate-300 transition-colors flex items-center gap-2 group"><i class="fa-solid fa-arrow-left mr-1 group-hover:-translate-x-1 transition-transform"></i> Back to Home</button>` 
                        : ''}
                    </div>
                    <div class="flex flex-wrap gap-3 justify-center sm:justify-start">
                        ${items}
                    </div>
                </section>
            `;
        }

        function renderPanel(panel) {
            const cardsData = panel.firstPage || panel.links || [];
            if (cardsData.length === 0) return '';
            const title = panel.panelDisplayName?.en || panel.panelDisplayName || panel.panelName;
            const subtitle = panel.panelSubtitle?.en || panel.panelSubtitle || '';
            const cardsHtml = cardsData.map(createCard).join('');
            return `
                <section class="animate-fade-in">
                    <div class="flex items-end gap-4 mb-6 border-b border-slate-800 pb-4">
                         <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                                <div class="h-6 w-1 bg-blue-500 rounded-full"></div>
                                <h2 class="text-2xl font-display font-bold text-white uppercase tracking-wide leading-none">${title}</h2>
                            </div>
                            ${subtitle ? `<p class="text-slate-500 text-sm font-medium ml-4">${subtitle}</p>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        ${cardsHtml}
                    </div>
                </section>
            `;
        }

        function renderIslandDetails(islandData) {
            const title = islandData.islandTitle || 'Unknown Island';
            const code = islandData.mnemonic || 'Unknown Code';
            const image = islandData.islandImage || 'https://via.placeholder.com/1280x720/151A23/ffffff?text=No+Image';
            const creator = islandData.creatorSlug || 'Unknown Creator';
            const accountId = islandData.accountId || ''; 
            const intro = islandData.localizedIntroduction || 'No description available.';
            const tagline = islandData.localizedTagline || '';
            const tags = islandData.descriptionTags || [];
            const version = islandData.gameVersion ? `v${islandData.gameVersion}` : '';
            const releaseDate = formatDate(islandData.firstReleased);
            const updateDate = formatDate(islandData.lastUpdated);
            const maxPlayers = islandData.maxPlayers || '-';

            const tagsHtml = tags.map(tag => 
                `<button onclick="fetchCategoryData('${sanitizeTag(tag)}', true)" class="px-3 py-1 bg-slate-800 text-slate-300 hover:text-white hover:bg-slate-700 hover:border-yellow-400 transition-all text-xs font-bold uppercase rounded-full border border-slate-700 cursor-pointer">${tag}</button>`
            ).join('');
            
            setTimeout(() => loadIslandMetrics(code), 100);

            return `
                <div class="animate-fade-in max-w-5xl mx-auto">
                    <button onclick="goBack()" class="mb-6 flex items-center gap-2 text-slate-400 hover:text-white transition-colors group">
                        <div class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center group-hover:border-yellow-400 transition-colors">
                            <i class="fa-solid fa-arrow-left text-sm"></i>
                        </div>
                        <span class="font-bold text-sm uppercase tracking-wider">Back</span>
                    </button>

                    <div class="relative rounded-3xl overflow-hidden shadow-2xl border border-slate-800 mb-8 group">
                        <div class="aspect-video md:aspect-[21/9] w-full">
                            <img src="${image}" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-[2s]" alt="${title}">
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-fn-dark via-fn-dark/50 to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-6 md:p-10 w-full">
                            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
                                <div>
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        ${islandData.isUEFN ? '<span class="bg-white text-black px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wide">UEFN</span>' : ''}
                                        ${version ? `<span class="bg-slate-800 text-slate-400 px-2 py-0.5 rounded text-[10px] font-bold uppercase">${version}</span>` : ''}
                                    </div>
                                    <h1 class="text-4xl md:text-6xl font-display font-bold text-white mb-2 leading-none shadow-sm">${title}</h1>
                                    <div class="flex items-center gap-3 text-slate-300 font-medium">
                                        <span>By <span class="text-yellow-400 hover:underline cursor-pointer" onclick="viewCreator('${accountId}', true)">${creator}</span></span>
                                        <span class="w-1 h-1 bg-slate-500 rounded-full"></span>
                                        <span>Released: ${releaseDate}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-start md:items-end gap-3">
                                    <button onclick="copyCode('${code}')" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold py-3 px-8 rounded-full shadow-[0_0_20px_rgba(250,204,21,0.4)] hover:shadow-[0_0_30px_rgba(250,204,21,0.6)] transition-all transform hover:-translate-y-1 flex items-center gap-3 text-lg">
                                        <span>${code}</span>
                                        <i class="fa-regular fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <div class="bg-fn-card border border-slate-800 p-6 rounded-2xl">
                                <h3 class="text-xl font-display font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-circle-info text-blue-500"></i> About
                                </h3>
                                ${tagline ? `<p class="text-lg text-white font-medium mb-4 italic border-l-4 border-yellow-400 pl-4 py-1 bg-slate-900/50 rounded-r-lg">${tagline}</p>` : ''}
                                <p class="text-slate-400 leading-relaxed whitespace-pre-line">${intro}</p>
                            </div>
                            
                            <div id="chart-container" class="hidden bg-fn-card border border-slate-800 p-6 rounded-2xl">
                                <h3 class="text-xl font-display font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-chart-line text-green-400"></i> 24h Player Activity
                                </h3>
                                <div class="h-64 w-full">
                                    <canvas id="ccuChart"></canvas>
                                </div>
                            </div>

                            ${tags.length > 0 ? `
                            <div>
                                <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">Tags</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${tagsHtml}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-fn-card border border-slate-800 p-5 rounded-2xl space-y-4">
                                <div class="flex items-center justify-between pb-3 border-b border-slate-800">
                                    <span class="text-slate-400 text-sm">Live Players</span>
                                    <span id="live-ccu-display" class="text-white font-bold font-mono flex items-center gap-2">
                                        <span class="w-2 h-2 bg-slate-600 rounded-full"></span>
                                        Loading...
                                    </span>
                                </div>
                                <div class="flex items-center justify-between pb-3 border-b border-slate-800">
                                    <span class="text-slate-400 text-sm">Max Players</span>
                                    <span class="text-white font-bold font-mono">${maxPlayers}</span>
                                </div>
                                <div class="flex items-center justify-between pb-3 border-b border-slate-800">
                                    <span class="text-slate-400 text-sm">Game Type</span>
                                    <span class="text-white font-bold">${islandData.gameType || 'Creative'}</span>
                                </div>
                                <div class="flex items-center justify-between pb-3 border-b border-slate-800">
                                    <span class="text-slate-400 text-sm">Last Updated</span>
                                    <span class="text-white font-bold text-sm">${updateDate}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400 text-sm">Age Rating</span>
                                    <span class="bg-slate-700 px-2 py-0.5 rounded text-xs font-bold text-white">${islandData.ageRating || 'E'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCreatorProfile(data) {
            const creator = data.creatorData;
            const islands = data.publishedIslands || [];
            const banner = creator.images?.banner || 'https://via.placeholder.com/1920x1080/151A23/ffffff?text=No+Banner';
            const avatar = creator.images?.avatar || 'https://via.placeholder.com/150/151A23/ffffff?text=?';
            const displayName = creator.displayName || 'Unknown Creator';
            const followers = formatNumber(creator.followerCount);
            
            const socials = creator.social || {};
            let socialLinksHtml = '';
            
            if (socials.twitter) socialLinksHtml += `<a href="https://twitter.com/${socials.twitter}" target="_blank" class="text-slate-400 hover:text-blue-400 transition-colors"><i class="fa-brands fa-twitter text-xl"></i></a>`;
            if (socials.youtube) socialLinksHtml += `<a href="https://youtube.com/${socials.youtube}" target="_blank" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-brands fa-youtube text-xl"></i></a>`;
            if (socials.instagram) socialLinksHtml += `<a href="https://instagram.com/${socials.instagram}" target="_blank" class="text-slate-400 hover:text-pink-500 transition-colors"><i class="fa-brands fa-instagram text-xl"></i></a>`;
            if (socials.twitch) socialLinksHtml += `<a href="https://twitch.tv/${socials.twitch}" target="_blank" class="text-slate-400 hover:text-purple-500 transition-colors"><i class="fa-brands fa-twitch text-xl"></i></a>`;
            if (socials.discord) socialLinksHtml += `<a href="${socials.discord}" target="_blank" class="text-slate-400 hover:text-indigo-400 transition-colors"><i class="fa-brands fa-discord text-xl"></i></a>`;

            const cardsHtml = islands.map(createCard).join('');

            return `
                <div class="animate-fade-in max-w-7xl mx-auto">
                    <button onclick="goBack()" class="mb-6 flex items-center gap-2 text-slate-400 hover:text-white transition-colors group z-20 relative">
                        <div class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center group-hover:border-yellow-400 transition-colors">
                            <i class="fa-solid fa-arrow-left text-sm"></i>
                        </div>
                        <span class="font-bold text-sm uppercase tracking-wider">Back</span>
                    </button>

                    <div class="relative w-full h-64 md:h-80 rounded-3xl overflow-hidden mb-16 border border-slate-800">
                        <img src="${banner}" class="w-full h-full object-cover" alt="Banner">
                        <div class="absolute inset-0 bg-gradient-to-t from-fn-dark to-transparent"></div>
                        <div class="absolute bottom-0 left-0 w-full p-6 md:p-10 flex flex-col md:flex-row items-center md:items-end gap-6">
                            <div class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-fn-dark overflow-hidden shadow-2xl bg-slate-800">
                                <img src="${avatar}" class="w-full h-full object-cover" alt="${displayName}">
                            </div>
                            <div class="flex-1 text-center md:text-left mb-2">
                                <h1 class="text-4xl md:text-5xl font-display font-bold text-white shadow-lg">${displayName}</h1>
                                <div class="flex flex-col md:flex-row items-center gap-4 mt-2">
                                    <div class="flex items-center gap-4 text-slate-300 font-medium">
                                        <span><i class="fa-solid fa-users text-yellow-400 mr-1"></i> ${followers} Followers</span>
                                        <span><i class="fa-solid fa-cube text-blue-400 mr-1"></i> ${islands.length} Islands</span>
                                    </div>
                                    ${socialLinksHtml ? `<div class="h-6 w-px bg-slate-600 hidden md:block"></div><div class="flex gap-4 bg-slate-900/50 px-4 py-2 rounded-full backdrop-blur-sm">${socialLinksHtml}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-2xl font-display font-bold text-white mb-6 pl-4 border-l-4 border-yellow-400">Published Islands</h3>
                        ${islands.length > 0 ? `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">${cardsHtml}</div>` : `<p class="text-slate-500 text-center py-10">No published islands found.</p>`}
                    </div>
                </div>
            `;
        }

        function renderApp(data) {
            const container = document.getElementById('main-container');
            container.innerHTML = '';
            if (!data) { container.innerHTML = '<div class="text-center text-red-400 mt-20">Error: No data received.</div>'; return; }
            if (currentView === 'home' || currentView === 'category') {
                const props = data.pageProps || {};
                const surfaces = props.searchSurfaces || window.cachedSurfaces || [];
                if (surfaces.length > 0) container.innerHTML += renderCategories(surfaces);
                const panels = props.discoveryData || props.surfacePanels;
                if (!panels || panels.length === 0) container.innerHTML += '<div class="text-center text-2xl text-slate-500 mt-20 font-display">No maps found.</div>';
                else container.innerHTML += panels.map(renderPanel).join('');
            } else if (currentView === 'details') {
                if(data.pageProps && data.pageProps.islandData) container.innerHTML = renderIslandDetails(data.pageProps.islandData);
                else container.innerHTML = '<div class="text-center text-red-400 mt-20">Failed to load island details.</div>';
            } else if (currentView === 'creator') {
                 if(data.success && data.creatorData) container.innerHTML = renderCreatorProfile(data);
                 else container.innerHTML = '<div class="text-center text-red-400 mt-20">Failed to load creator profile.</div>';
            }
        }

        function setStatus(type) {
            const el = document.getElementById('status-indicator');
            const dotPing = el.querySelector('.animate-ping');
            const dot = el.querySelector('.relative.inline-flex');
            
            dotPing.className = 'animate-ping absolute inline-flex h-full w-full rounded-full opacity-75';
            dot.className = 'relative inline-flex rounded-full h-2.5 w-2.5';
            
            if (type === 'loading') {
                dotPing.classList.add('bg-yellow-400');
                dot.classList.add('bg-yellow-500');
                el.className = "text-xs font-bold px-2 py-2 rounded-full border border-yellow-500/30 bg-yellow-500/10 text-yellow-400 flex items-center justify-center shadow-sm w-8 h-8 transition-all";
            } else if (type === 'success') {
                dotPing.classList.add('bg-green-400');
                dot.classList.add('bg-green-500');
                el.className = "text-xs font-bold px-2 py-2 rounded-full border border-green-500/30 bg-green-500/10 text-green-400 flex items-center justify-center shadow-sm w-8 h-8 transition-all";
            } else if (type === 'cached') {
                dotPing.classList.add('bg-blue-400');
                dot.classList.add('bg-blue-500');
                el.className = "text-xs font-bold px-2 py-2 rounded-full border border-blue-500/30 bg-blue-500/10 text-blue-400 flex items-center justify-center shadow-sm w-8 h-8 transition-all";
            } else { 
                dotPing.classList.add('bg-red-400');
                dot.classList.add('bg-red-500');
                el.className = "text-xs font-bold px-2 py-2 rounded-full border border-red-500/30 bg-red-500/10 text-red-400 flex items-center justify-center shadow-sm w-8 h-8 transition-all";
            }
        }

        async function fetchHomeData(pushState = true) {
            currentView = 'home';
            currentCategoryName = '';
            currentIslandCode = '';
            if (pushState) updateURL('/discovery');
            const fullUrl = NEXT_DATA_API + HOME_ENDPOINT;
            const data = await performFetch(fullUrl);
            if (data) {
                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data));
                const now = Date.now();
                localStorage.setItem(STORAGE_KEY_TIMESTAMP, now.toString());
                updateLastUpdatedTime(now);
                setStatus('success');
                renderApp(data);
                return now;
            } else {
                if (!localStorage.getItem(STORAGE_KEY_DATA)) renderApp(SAMPLE_DATA);
                return Date.now(); 
            }
        }

        async function fetchCategoryData(surfaceName, pushState = true) {
            currentView = 'category';
            currentCategoryName = surfaceName;
            currentIslandCode = '';
            if (pushState) updateURL('/creative', { tag: surfaceName });
            const fullUrl = `${NEXT_DATA_API}/discover/${surfaceName}.json?surfaceName=${surfaceName}`;
            document.getElementById('main-container').innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-500 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-slate-600"></i><p>Loading ${surfaceName}...</p></div>`;
            const data = await performFetch(fullUrl);
            if (data) { setStatus('success'); renderApp(data); }
            else { setStatus('error'); document.getElementById('main-container').innerHTML = '<div class="text-center text-red-400 mt-20">Failed to load category.</div>'; }
        }

        async function viewIsland(code, pushState = true) {
            currentView = 'details';
            currentIslandCode = code;
            if (pushState) updateURL('/island', { code: code });
            const fullUrl = `${NEXT_DATA_API}/creative/${code}.json?islandCode=${code}`;
            document.getElementById('main-container').innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-500 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-slate-600"></i><p>Loading Island Details...</p></div>`;
            const data = await performFetch(fullUrl);
            if (data) { setStatus('success'); renderApp(data); }
            else { setStatus('error'); document.getElementById('main-container').innerHTML = '<div class="text-center text-red-400 mt-20">Failed to load island details.</div>'; }
        }

        async function viewCreator(accountId, pushState = true) {
            if(!accountId) return;
            currentView = 'creator';
            currentCreatorId = accountId;
            if (pushState) updateURL('/creator', { name: accountId });
            const fullUrl = `${BACKEND_API}/creator/${accountId}`;
            document.getElementById('main-container').innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-500 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-slate-600"></i><p>Loading Creator Profile...</p></div>`;
            const data = await performFetch(fullUrl);
            if (data) { setStatus('success'); renderApp(data); }
            else { setStatus('error'); document.getElementById('main-container').innerHTML = '<div class="text-center text-red-400 mt-20">Failed to load creator.</div>'; }
        }

        async function checkAndSchedule() {
            await runSecurityChecks();
            handleRouting(); 
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (currentView !== 'home') return;
                const now = Date.now();
                const lastFetchStr = localStorage.getItem(STORAGE_KEY_TIMESTAMP);
                let lastFetch = lastFetchStr ? parseInt(lastFetchStr) : 0;
                let timeElapsed = now - lastFetch;
                const remaining = REFRESH_INTERVAL_MS - timeElapsed; 
                if (remaining <= 0) fetchHomeData(false); 
                else updateTimerDisplay(remaining);
            }, 1000);
            const now = Date.now();
            const lastFetchStr = localStorage.getItem(STORAGE_KEY_TIMESTAMP);
            let lastFetch = lastFetchStr ? parseInt(lastFetchStr) : 0;
            let timeElapsed = now - lastFetch;
            updateTimerDisplay(Math.max(0, REFRESH_INTERVAL_MS - timeElapsed));
        }

        window.addEventListener('DOMContentLoaded', checkAndSchedule);
    </script>
</body>
</html>
